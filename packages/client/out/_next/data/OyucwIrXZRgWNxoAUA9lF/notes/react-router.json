{"pageProps":{"metaTitle":"react-router","article":{"title":"react-router","content":"# history\r\n\r\nhistory æ˜¯ä¸€ä¸ªç”¨äºæä¾›ç±»ä¼¼æµè§ˆå™¨ history å¯¹è±¡å®ç°é¡µé¢çš„æ— åˆ·æ–°è·³è½¬çš„åº“ï¼Œè¯¥åº“æ˜¯ react-router çš„æ ¸å¿ƒä¾èµ–ã€‚\r\n\r\nhistory åº“æä¾›çš„åŠŸèƒ½ï¼š\r\n\r\n- ä¸‰ç§ historyï¼šbrowserHistoryã€hashHistoryã€memoryHistoryï¼Œæä¾›ç›¸åº”çš„ create å‡½æ•°å¹¶ä¿æŒç»Ÿä¸€çš„ api\r\n- æ”¯æŒå‘å¸ƒ/è®¢é˜…ï¼Œå½“ URL å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¼šå‘å¸ƒè®¢é˜…\r\n- æä¾›è·³è½¬æ‹¦æˆªã€è·³è½¬ç¡®è®¤å’Œ `basename` ç­‰åŠŸèƒ½\r\n\r\nä¸€ä¸ª `history` å¯¹è±¡æ‰€å…·æœ‰çš„å±æ€§ï¼š\r\n\r\n```javascript\r\nconst history = {\r\n    length,\r\n    action,\r\n    location:,\r\n    createHref,\r\n    push,\r\n    replace,\r\n    go,\r\n    goBack,\r\n    goForward,\r\n    block,\r\n    listen\r\n}\r\n```\r\n\r\n- `length`ï¼šå†å²è®°å½•å †æ ˆçš„é•¿åº¦ï¼Œå®ç°ä¹Ÿéå¸¸ç®€å•å°±æ˜¯ `(globalHistory = window.history).length`\r\n- `action`ï¼šè¡¨ç¤ºå½“å‰é¡µé¢æ˜¯é€šè¿‡ä»€ä¹ˆè¡Œä¸ºè¿›å…¥çš„ï¼Œå–å€¼ä¸º `'POP'`ã€`'PUSH'`ã€`'REPLACE'`ï¼Œé»˜è®¤å€¼ä¸º `'POP'`\r\n- `location`ï¼šå’Œ `window.location` ç±»ä¼¼ï¼Œreact-router ä¸Šä¸‹æ–‡ä¸­çš„ `location` å¯¹è±¡å°±æ˜¯è¯¥å¯¹è±¡\r\n- `createHref`ï¼šæ ¹æ® `location` å¯¹è±¡ä»¥åŠ `basename` åˆ›å»ºä¸€ä¸ª `path` å­—ç¬¦ä¸²\r\n- `block`ï¼šå‘é¡µé¢æ·»åŠ ä¸€ä¸ªé˜»å¡ï¼Œåˆ›å»º `history` çš„æ—¶å€™å¯ä»¥ä¼ é€’ä¸€ä¸ª `getUserConfirmation` å‡½æ•°ç”¨äºåˆ¤æ–­æ˜¯å¦æ‹¦æˆªè·³è½¬\r\n- `listen`ï¼š æ·»åŠ ä¸€ä¸ªè®¢é˜…ï¼Œå½“ URL å‘é€æ”¹å˜ä¼šè‡ªåŠ¨å‘å¸ƒè®¢é˜…\r\n\r\n> ä¸»è¦çœ‹ browserHistory çš„å®ç°\r\n\r\n## location\r\n\r\nlocation å¯¹è±¡çš„æ ¼å¼ï¼š\r\n\r\n```json\r\n{\r\n    key: \"xxx\",\r\n    pathname: '/xxx', \r\n    search: '?xxx', \r\n    hash: '#xxx',\r\n    state: xxx\r\n}\r\n```\r\n\r\n`location` å…·æœ‰çš„ç‰¹ç‚¹ï¼š\r\n\r\n- æ¯ä¸ª `location` å¯¹è±¡éƒ½å…·æœ‰ä¸€ä¸ªå”¯ä¸€çš„ `key` å€¼\r\n- æ¯ä¸ª `location` å¯¹è±¡éƒ½å…·æœ‰ `state` å±æ€§ï¼Œè¯¥å€¼æ˜¯é€šè¿‡ `history.push` æ‰€ä¼ é€’çš„å€¼\r\n- å¦‚æœ URL å­˜åœ¨ query å’Œ hashï¼Œ`search` å±æ€§å¿…å®šä»¥ `?` å¼€å¤´ï¼Œ`hash` å¿…å®šä»¥ `#` å¼€å¤´ï¼Œå¦åˆ™ä¸¾æ˜¯ç©ºä¸²\r\n\r\n### åˆ›å»º\r\n\r\nè¯¥å¯¹è±¡æ˜¯é€šè¿‡ LocationUtil æ¨¡å—ä¸‹çš„ `createLocation` æ‰€åˆ›å»ºï¼Œå½“è·³è½¬åˆ°ä¸€ä¸ªæ–°åœ°å€æ—¶éƒ½ä¼šå…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ `location` å¯¹è±¡ã€‚\r\n\r\né€šè¿‡ `history.push` å¯ä»¥ä¼ é€’å‡ ç§æ ¼å¼çš„è·¯å¾„ï¼Œéƒ½æ˜¯è¯¥å‡½æ•°å¸®å¿™å¤„ç†çš„ï¼š\r\n\r\n- å¯ä»¥ä¼ é€’å¯¹è±¡æ ¼å¼çš„è·¯å¾„ï¼Œ`{pathname: xxx, hash: xxx, search: 'xxx'}`\r\n- å¯ä»¥ä¼ é€’å®Œæ•´çš„å­—ç¬¦ä¸²è·¯å¾„\r\n- å¯ä»¥ä¼ é€’ä¸å®Œæ•´çš„è·¯å¾„ï¼Œä¼šæ ¹æ®å½“å‰çš„è·¯å¾„è¿›è¡Œè¡¥å…¨\r\n\r\n```javascript\r\nfunction createLocation(path, state, key, currentLocation) {\r\n    let location;\r\n    // path å¯ä»¥æ˜¯locationæ ¼å¼å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥æ˜¯è·¯å¾„å­—ç¬¦ä¸²\r\n    if (typeof path === 'string') {\r\n        // Two-arg form: push(path, state)\r\n        // parsePath å°† path å­—ç¬¦ä¸²è§£æä¸º { pathname: '/xxx', search: '?xxx', hash: '#xxx' } çš„æ ¼å¼\r\n        location = parsePath(path);\r\n        location.state = state;\r\n    } else {\r\n        // One-arg form: push(location)\r\n        location = { ...path };\r\n        // å¤„ç† search hash state\r\n    }\r\n\r\n    if (key) location.key = key;\r\n\r\n    // path å¯ä»¥ä¼ é€’çš„æ˜¯ä¸å®Œæ•´çš„è·¯å¾„ï¼Œå› ä¸ºä¼šæ ¹æ® currentLocation è¿›è¡Œè¡¥å…¨\r\n    if (currentLocation) {\r\n        // Resolve incomplete/relative pathname relative to current location\r\n    } else {\r\n        // When there is no prior location and pathname is empty, set it to /\r\n    }\r\n\r\n    return location;\r\n}\r\n```\r\n\r\n### åˆå§‹å€¼\r\n\r\nä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ `location` çš„åˆå§‹å€¼çš„å®ç°ï¼š\r\n\r\nåˆå§‹çš„ `location` æ˜¯é€šè¿‡ `window.location` å’Œ `window.history.state` åˆ›å»ºï¼Œå› ä¸ºè¯¥å‡½æ•°å¯èƒ½æ˜¯åˆšè¿›å…¥é¡µé¢è¿è¡Œï¼Œä¹Ÿå¯èƒ½æ˜¯é€šè¿‡åˆ·æ–°é¡µé¢å¯¼è‡´è¿è¡Œï¼Œä½†æ˜¯åˆ·æ–°å¹¶ä¸ä¼šæ¸…ç©º `window.history.state` çš„å€¼ã€‚\r\n\r\n```javascript\r\n// åˆå§‹çš„ location å€¼ï¼Œé€šè¿‡ window.location å’Œ window.history.state åˆ›å»º\r\n// å› ä¸ºåˆ·æ–°å¹¶ä¸ä¼š æ¸…ç©º window.history.state çš„å€¼\r\nconst initialLocation = getDOMLocation(getHistoryState());\r\n\r\n// é€šè¿‡ window.location å’Œ window.history.state åˆ›å»º location\r\nfunction getDOMLocation(historyState) {\r\n    const { key, state } = historyState || {};\r\n    const { pathname, search, hash } = window.location;\r\n\r\n    let path = pathname + search + hash;\r\n\r\n    if (basename) path = stripBasename(path, basename);\r\n\r\n    return createLocation(path, state, key);\r\n}\r\n\r\nfunction getHistoryState() {\r\n    return window.history.state || {};\r\n}\r\n```\r\n\r\n### keyå€¼\r\n\r\næ¯”è¾ƒå¥½å¥‡çš„æ˜¯ `location` å¯¹è±¡çš„ `key` å±æ€§çš„ä½œç”¨ï¼Œcreate å‡½æ•°å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª `allkeys` é˜Ÿåˆ—ï¼Œå’Œæµè§ˆå™¨çš„å†å²è®°å½•å †æ ˆç±»ä¼¼ï¼Œè¯¥é˜Ÿåˆ—ä¹ŸæŒ‰ç…§å†å²è®°å½•å †æ ˆçš„é¡ºåºå­˜æ”¾ç€ç›¸å¯¹ä¸€ä¸ªçš„ `location` çš„ `key` å€¼ã€‚\r\n\r\næœ‰ä»€ä¹ˆç”¨ï¼Ÿä¸çŸ¥é“ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼Œåº”è¯¥æ˜¯ä¸ºäº†ååºæ–°å¢çš„åŠŸèƒ½é“ºå«ã€‚åœ¨ `revertPop` æ–¹æ³•ä¸­å†™äº† TODOï¼š\r\n\r\n```javascript\r\n// TODO: We could probably make this more reliable by\r\n// keeping a list of keys we've seen in sessionStorage.\r\n// Instead, we just default to 0 for keys we don't know.\r\n```\r\n\r\n> è¯¥å‡½æ•°æ²¡çœ‹å‡ºæ¥å¯¹ç°æœ‰çš„åŠŸèƒ½æœ‰å•¥å½±å“ï¼Œæ„Ÿè§‰å¯ä»¥å¿½ç•¥è¯¥æ–¹æ³•\r\n\r\n## transitionManager\r\n\r\nå› ä¸º history æä¾›äº†è·³è½¬æ‹¦æˆªï¼Œå‘å¸ƒ/è®¢é˜…ç­‰åŠŸèƒ½ï¼Œè¿™ä¹Ÿæ˜¯åœ¨æ¯æ¬¡è·³è½¬æ—¶éœ€è¦å¤„ç†çš„ä¸€äº›äº‹æƒ…ã€‚\r\n\r\nhistory é€šè¿‡ transitionManager å¯¹è±¡æ¥å®ç°è¿™äº›åŠŸèƒ½ï¼Œé€šè¿‡åå­—å°±èƒ½çœ‹å‡ºæ¥ï¼Œè¿‡æ¸¡ç®¡ç†ï¼Œä¸€çœ‹å°±æ˜¯å¤„ç†è·Ÿé¡µé¢çš„è¿‡åº¦æœ‰å…³åŠŸèƒ½ã€‚\r\n\r\nè¯¥å¯¹è±¡é€šè¿‡ `createTransitionManager` åˆ›å»ºï¼Œå…·æœ‰ `setPrompt`ã€`confirmTransitionTo`ã€`appendListener`ã€`notifyListeners` å‡ ä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ˜¯ `history` ä¸€äº›æ–¹æ³•å®ç°çš„æ ¸å¿ƒã€‚\r\n\r\næ¯ä¸ª history å¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ª transitionManager å¯¹è±¡ï¼Œåœ¨åˆé€‚çš„æ—¶å€™åªéœ€è°ƒç”¨å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚\r\n\r\n### è·³è½¬æ‹¦æˆª\r\n\r\nå…ˆæ¥å›é¡¾è·³è½¬æ‹¦æˆªæ€ä¹ˆä½¿ç”¨ï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ `history.block` è®¾ç½®ä¸€ä¸ªé˜»å¡ï¼Œæ¥ç€æˆ‘ä»¬åœ¨ `getUserConfirmation` ä¸­åˆ¤æ–­å¤„ç†æ˜¯å¦å…è®¸è·³è½¬ï¼Œ`getUserConfirmation` æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š\r\n\r\n1. å‚æ•°1ï¼šé˜»å¡ä¼ é€’çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬é€šè¿‡ `block` ä¼ é€’\r\n2. å‚æ•°2ï¼šä¸€ä¸ªè·³è½¬çš„å›è°ƒå‡½æ•°ï¼Œå‘å…¶ä¼ é€’ `true` å…è®¸è·³è½¬ï¼Œä¼ é€’ `false` é˜»å¡\r\n\r\n#### setPrompt\r\n\r\n`history.block` æœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ `setPrompt`ï¼Œè¯¥æ–¹æ³•çš„çš„ç›®çš„å°±æ˜¯è®¾ç½®ä¸€ä¸ªé˜»å¡ï¼Œæ˜¯å¦è·³è½¬éƒ½æ˜¯å…¶ä»–æ–¹æ³•æ¥å¤„ç†ï¼Œæ‰€ä»¥åªéœ€è¦ç”¨ä¸€ä¸ªå…±äº«çš„å˜é‡æ¥æ ‡è¯†å·²ç»è®¾ç½®äº†æ‹¦æˆªå°±å¯ä»¥äº†ã€‚\r\n\r\nè¯¥æ–¹æ³•çš„å®ç°å¾ˆç®€å•ï¼Œå› ä¸º transitionManager æ˜¯é€šè¿‡å‡½æ•°æ‰€åˆ›å»ºï¼Œé€šè¿‡ä¸€ä¸ªå˜é‡ `prompt` åˆ©ç”¨é—­åŒ…å®ç°æ ‡è¯†æ‹¦æˆªä¸å¦ã€‚\r\n\r\n```javascript\r\nlet prompt = null;\r\n\r\n// è®¾ç½®é˜»å¡æ¶ˆæ¯ï¼Œprompt å¯ä»¥æ˜¯è¿”å›å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œblock æ—¶ä¼ å…¥\r\n// prompt èµ·åˆ°äº†åŒé‡ä½œç”¨ï¼Œä¸€æ˜¯æ ‡è¯†æ˜¯å¦è®¾ç½®äº†æ‹¦æˆªï¼Œä¸€æ˜¯å­˜å‚¨ç€é˜»å¡æ¶ˆæ¯\r\nfunction setPrompt(nextPrompt) {\r\n    prompt = nextPrompt;\r\n    return () => {\r\n        if (prompt === nextPrompt) prompt = null;\r\n    };\r\n}\r\n```\r\n\r\n#### confirmTransitionTo\r\n\r\né€šè¿‡å‡½æ•°åå°±èƒ½çœ‹å‡ºæ¥ï¼Œæ˜¯å¦è·³è½¬ç”±æˆ‘æ¥å¤„ç†ï¼Œè€Œä¸”è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•ï¼Œå½“éœ€è¦è·³è½¬æ—¶ä½ è°ƒç”¨æˆ‘å°±è¡Œã€‚\r\n\r\nè·³ä¸è·³è½¬çš„äº‹æˆ‘æ¥å¤„ç†ï¼Œä½ æŠŠ `location` å’Œå®ç°è·³è½¬çš„æ–¹æ³•ä½œä¸º callback ä¼ é€’ç»™æˆ‘ï¼Œæ¯•ç«Ÿæˆ‘ä¸çŸ¥é“æ€ä¹ˆè·³è½¬è€Œä¸”è·³è½¬çš„å®ç°å¤šç§å¤šæ ·ï¼Œè€Œä¸”è·³è½¬æœ‰æ—¶å€™éœ€è¦ `getUserConfirmation` æ¥å†³å®šã€‚\r\n\r\n> callback çš„æ ¼å¼ï¼šç»™ä½ ä¼  `true` ä½ å°±è·³è½¬ï¼Œä¸ªäººè§‰å¾—è·³è½¬å‡½æ•°åº”è¯¥ä¸æ¥å—å‚æ•°ï¼Œåº”è¯¥è®©æ­¤å‡½æ•°å†³å®šæ˜¯å¦è°ƒç”¨ callback è¿™æ ·æ›´åŠ å¥½ã€‚\r\n\r\n```javascript\r\nfunction confirmTransitionTo(location,  action, getUserConfirmation, callback) {\r\n    if (prompt != null) {\r\n        // prompt å¯ä»¥æ˜¯è¿”å›å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²\r\n        const result = typeof prompt === 'function' ? prompt(location, action) : prompt;\r\n        if (typeof result === 'string') {\r\n            getUserConfirmation(result, callback);\r\n        } else {\r\n            // Return false from a transition hook to cancel the transition.\r\n            // å¦‚æœä¼ é€’çš„çš„é˜»å¡æ¶ˆæ¯/å‡½æ•°è¿”å›çš„é˜»å¡æ¶ˆæ¯ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œ\r\n            // å½“è¯¥æ¶ˆæ¯ === false æ—¶ä¸è·³è½¬ï¼Œå…¶ä»–éƒ½è·³è½¬\r\n            callback(result !== false);\r\n        }\r\n    } else { // å¦‚æœæ²¡æœ‰é˜»å¡ï¼Œç›´æ¥è·³è½¬\r\n        callback(true);\r\n    }\r\n}\r\n```\r\n\r\n### å‘å¸ƒè®¢é˜…\r\n\r\nä¸€ä¸ªå…¸å‹çš„å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œè¦å®ç°è¯¥åŠŸèƒ½å¿…å®šæœ‰ä¸€ä¸ªé˜Ÿåˆ—å­˜æ”¾ç€ç›‘å¬å‡½æ•°ï¼Œåœ¨ `appendListener` æ—¶æ·»åŠ ï¼Œåœ¨ `notifyListeners` è°ƒç”¨ã€‚\r\n\r\næ¯”è¾ƒå·§å¦™çš„æ˜¯ `appendListener` çš„å®ç°ï¼Œå› ä¸ºç›‘å¬æ˜¯å¯ä»¥å–æ¶ˆçš„ï¼Œæ‰€ä»¥å¿…å®šè¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤ç›¸å¯¹åº”çš„ `listener`ï¼Œåˆ©ç”¨é—­åŒ…éå¸¸çš„å·§å¦™å®ç°äº†è¿™ä¸€ç‚¹ã€‚\r\n\r\n```javascript\r\nlet listeners = [];\r\n\r\n// æ·»åŠ  ç›‘å¬è€…ï¼Œè¿”å›å–æ¶ˆç›‘å¬å‡½æ•°\r\nfunction appendListener(fn) {\r\n    // é€šè¿‡ isActive æ¥è¿›è¡Œç›‘å¬å‡½æ•°çš„è¿‡æ»¤\r\n    let isActive = true;\r\n\r\n    function listener(...args) {\r\n        if (isActive) fn(...args);\r\n    }\r\n\r\n    listeners.push(listener);\r\n\r\n    return () => {\r\n        isActive = false;\r\n        listeners = listeners.filter(item => item !== listener);\r\n    };\r\n}\r\n\r\n// notify åˆ†å‘ç›‘å¬\r\nfunction notifyListeners(...args) {\r\n    listeners.forEach(listener => listener(...args));\r\n}\r\n\r\n```\r\n\r\n## push\r\n\r\npush æ˜¯æ•´ä¸ª history å¯¹è±¡ä¸­æœ€é‡è¦çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç”¨çš„æœ€å¤šçš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯æ”¹å˜ URL åœ°å€é¡ºä¾¿å’Œå¯ä»¥ç»™æ–°çš„é¡µé¢ä¼ é€’æ•°æ®ã€‚\r\n\r\nä¸€æ—¦è¿›è¡Œäº†é¡µé¢çš„è·³è½¬ï¼Œhistory å¯¹è±¡å°±éœ€è¦è¿›è¡Œæ›´æ–°ï¼Œ`action` å’Œ `location` è‚¯å®šæ˜¯éœ€è¦æ”¹å˜çš„ï¼Œè¿™ä¸€ç‚¹è¿˜æ˜¯å¾ˆå¥½å®ç°çš„ã€‚\r\n\r\nè€ŒURL çš„æ”¹å˜ç›´æ¥ä½¿ç”¨ `window.history.pushState` å°±å¯ä»¥å¾ˆç®€å•çš„å®ç°ã€‚\r\n\r\nç”±äºå¯èƒ½ä¼šå­˜åœ¨è·³è½¬æ‹¦æˆªï¼Œæ‰€ä»¥å¿…å®šéœ€è¦è°ƒç”¨ `confirmTransitionTo` æ–¹æ³•ï¼Œç„¶åå°†è·³è½¬çš„æ“ä½œä½œä¸º callback ä¼ é€’ã€‚\r\n\r\n```javascript\r\nfunction push(path, state) {\r\n    const action = 'PUSH';\r\n    // å°†æ–°çš„è·¯å¾„å¯¹åº”çš„ location å¯¹è±¡åˆ›å»ºå‡ºæ¥\r\n    const location = createLocation(path, state, createKey(), history.location);\r\n\r\n    // æ¯æ¬¡è·³è½¬éƒ½è¦è¿›è¡Œ è·³è½¬ç¡®è®¤\r\n    transitionManager.confirmTransitionTo(\r\n        location,\r\n        action,\r\n        getUserConfirmation,\r\n        ok => {\t// å‘ callback ä¼ é€’ true å…è®¸è·³è½¬ï¼Œå¦åˆ™ä¸è·³è½¬\r\n            if (!ok) return;\r\n            // æ ¹æ®æ–°çš„ location å¯¹è±¡åˆ›å»ºæ–°çš„ path è·¯å¾„\r\n            const href = createHref(location);\r\n            const { key, state } = location;\r\n            // é€šè¿‡ h5 çš„ history api æ”¹å˜ url åœ°å€\r\n            // ç”Ÿæˆçš„ key å’Œä¼ é€’çš„ stateä¼šè¢«ä¿å­˜åˆ° window.history.state ä¸­\r\n            globalHistory.pushState({ key, state }, null, href);\r\n            // æ›´æ–° history å¯¹è±¡\r\n            setState({ action, location });\r\n        }\r\n    );\r\n}\r\n```\r\n\r\n`setState` åšçš„äº‹å¾ˆç®€å•ï¼Œå°±æ˜¯æ›´æ–° history å¯¹è±¡ï¼Œå¹¶é¡ºä¾¿åˆ†å‘ä¸€ä¸‹è®¢é˜…ï¼š\r\n\r\n```javascript\r\n// ç”¨äºæ›´æ–° history ï¼Œä»¥åŠåˆ†å‘ listener\r\nfunction setState(nextState) {\r\n    // æ›´æ–° action å’Œ location\r\n    Object.assign(history, nextState);\r\n    // æ›´æ–° length\r\n    history.length = globalHistory.length;\r\n    // notify æ‰€æœ‰ listener\r\n    transitionManager.notifyListeners(history.location, history.action);\r\n}\r\n```\r\n\r\næˆ‘ä»¬ä¼ é€’çš„ `state` ä¼šè¢«ä¿å­˜åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯ `history.location.state`ï¼Œå¦ä¸€ä¸ªæ˜¯ `window.history.state`\r\n\r\n`replace` çš„å®ç°å¾ˆç®€å•å’Œ `push` ä¸€æ ·ï¼Œä¸ä¸€æ ·çš„ä»…ä»…æ˜¯ `aciton` çš„å€¼ä¸º `'REPLACE'`ï¼Œè·³è½¬è°ƒç”¨çš„æ˜¯ `window.history.replaceState`\r\n\r\n## block\r\n\r\nç”±äº transitionManager å¯¹è±¡å®ç°äº† `setPrompt` æ–¹æ³•ï¼Œæ‰€ä»¥ `block` æ–¹æ³•å®ç°é˜»å¡åªéœ€è¦è°ƒç”¨è¯¥æ–¹æ³•å°±å¯ä»¥ï¼Œä½†æ˜¯éœ€è¦æ³¨å†Œ `popState` äº‹ä»¶å› ä¸ºå½“ä½¿ç”¨æµè§ˆå™¨å‰è¿›åé€€æ—¶ä¹Ÿéœ€è¦è¿›è¡Œè·³è½¬æ‹¦æˆªçš„ç¡®è®¤ã€‚\r\n\r\n`listen` çš„å®ç°å’Œ `block` çš„å®ç°ç±»ä¼¼ï¼Œå› ä¸ºä¸€æ—¦è®¾ç½®äº†ç›‘å¬ï¼Œè·³è½¬æ—¶éœ€è¦åˆ†å‘è®¢é˜…ã€‚\r\n\r\n```javascript\r\nlet isBlocked = false;\r\n\r\n// æ·»åŠ ä¸€ä¸ªé˜»å¡\r\nfunction block(prompt = false) {\r\n    const unblock = transitionManager.setPrompt(prompt);\r\n\r\n    // é˜²æ­¢é‡å¤æ³¨å†Œäº‹ä»¶\r\n    if (!isBlocked) {\r\n        checkDOMListeners(1);\r\n        isBlocked = true;\r\n    }\r\n\r\n    // é˜²æ­¢é‡å¤è°ƒç”¨\r\n    return () => {\r\n        if (isBlocked) {\r\n            isBlocked = false;\r\n            checkDOMListeners(-1);\r\n        }\r\n\r\n        return unblock();\r\n    };\r\n}\r\n```\r\n\r\n### äº‹ä»¶å¤„ç†\r\n\r\nå½“è®¾ç½®äº† block / listen æ—¶ï¼Œå½“é€šè¿‡æµè§ˆå™¨è¿›è¡Œå‰è¿›åé€€æ—¶ï¼Œä¹Ÿéœ€è¦è·³è½¬æ£€æµ‹ã€‚\r\n\r\n`checkDOMListeners` æ–¹æ³•å®ç°äº†äº‹ä»¶çš„æ·»åŠ å’Œå–æ¶ˆã€‚\r\n\r\n```javascript\r\n// æ·»åŠ  popState äº‹ä»¶å¤„ç†ï¼Œå½“ä½¿ç”¨ å‰è¿›åé€€ æ—¶ï¼Œä¹Ÿéœ€è¦è·³è½¬æ£€æµ‹ï¼Œä»¥åŠç”¨äºå–æ¶ˆè¯¥äº‹ä»¶å¤„ç†\r\n// è¯¥æ–¹æ³•åªæœ‰å½“è®¾ç½®äº† block / listen æ—¶æ‰æœ‰å¿…è¦\r\nfunction checkDOMListeners(delta) {\r\n    listenerCount += delta;\r\n    if (listenerCount === 1 && delta === 1) {\r\n        window.addEventListener(PopStateEvent, handlePopState);\r\n    } else if (listenerCount === 0) {\r\n        window.removeEventListener(PopStateEvent, handlePopState);\r\n    }\r\n}\r\n\r\n// å¤„ç† popstate äº‹ä»¶\r\nfunction handlePopState(event) {\r\n    handlePop(getDOMLocation(event.state));\r\n}\r\n\r\nfunction handlePop(location) {\r\n    const action = 'POP';\r\n    // æ ¹æ®é˜»å¡æ›´æ–° history \r\n    transitionManager.confirmTransitionTo(\r\n        location,\r\n        action,\r\n        getUserConfirmation,\r\n        ok => {\r\n            if (ok) {\r\n                setState({ action, location });\r\n            } else {\r\n                revertPop(location);\r\n            }\r\n        }\r\n    );\r\n}\r\n```\r\n\r\n# å…¶ä»–\r\n\r\n## basename\r\n\r\nhistory æä¾›äº† `basename` åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„é¡¹ç›®å¯èƒ½ä¸æ˜¯éƒ¨ç½²åœ¨ç½‘ç«™çš„æ ¹ç›®å½•ï¼Œåœ¨åˆ›å»º history çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥æŒ‡å®š basenameï¼Œç„¶åå†™é¡¹ç›®æ—¶å¯ä»¥å½“ä½œé¡¹ç›®å°±æ˜¯éƒ¨ç½²åœ¨æ ¹ç›®å½•ä¸€æ ·æ¥å†™ï¼Œhistory å¸®æˆ‘ä»¬å¤„ç†çš„è¿™ä¸ªé—®é¢˜ã€‚\r\n\r\nå¤„ç†æ–¹å¼å°±æ˜¯é€šè¿‡ `createHref` çš„å®ç°ï¼Œè¯¥å‡½æ•°æ˜¯åˆ›å»ºä¸€ä¸ª `path` å­—ç¬¦ä¸²ï¼Œä¸€èˆ¬ç”¨äºå†…éƒ¨çš„å®ç°ã€‚å®ƒçš„å®ç°å¾ˆç®€å•ï¼š\r\n\r\n```javascript\r\n// åˆ›å»ºä¸€ä¸ª path å­—ç¬¦ä¸²\r\nfunction createHref(location) {\r\n    return basename + createPath(location);\r\n}\r\n\r\n// é€šè¿‡ location å¯¹è±¡åˆ›å»º pathï¼Œpathæ ¼å¼ä¸º /path?query#hash\r\nfunction createPath(location) {\r\n    const { pathname, search, hash } = location;\r\n\r\n    let path = pathname || '/';\r\n\r\n    if (search && search !== '?')\r\n        path += search.charAt(0) === '?' ? search : `?${search}`;\r\n\r\n    if (hash && hash !== '#') path += hash.charAt(0) === '#' ? hash : `#${hash}`;\r\n\r\n    return path;\r\n}\r\n```\r\n\r\n## getUserConfirmation\r\n\r\nåœ¨æˆ‘ä»¬ä½¿ç”¨ react-router çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°æ²¡æœ‰ä¼ é€’ `getUserConfirmation`ï¼Œæœ‰é»˜è®¤çš„å¤„ç†æ–¹å¼ï¼Œhistory æä¾›äº†è¯¥æ–¹æ³•çš„é»˜è®¤å®ç°ï¼š\r\n\r\n```javascript\r\n// é»˜è®¤ gerUserConfirmation å®ç°\r\nfunction getConfirmation(message, callback) {\r\n    callback(window.confirm(message)); // eslint-disable-line no-alert\r\n}\r\n```\r\n\r\n# react-router\r\n\r\nreact-router æœ¬èº«çš„å®ç°æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ ¸å¿ƒçš„åŠŸèƒ½éƒ½è¢« history å®ç°äº†ã€‚\r\n\r\nåªéœ€è¦æ ¹æ® path çš„åŒ¹é…ä¸å¦æ¥æ¸²æŸ“å¯¹åº”çš„ç»„ä»¶ï¼Œä»¥åŠæä¾›ä¸Šä¸‹æ–‡æ•°æ®ã€‚ä¸»è¦å°±æ˜¯å®ç°ä¸€äº›ç”¨äºè·¯ç”±çš„ç»„ä»¶ã€‚\r\n\r\n## ä¸Šä¸‹æ–‡\r\n\r\nreact-router ä¸­å®šä¹‰äº†ä¸¤ä¸ªä¸Šä¸‹æ–‡ï¼Œä¸€ä¸ªæ˜¯ `RouterContext`ï¼Œå¦ä¸€ä¸ªæ˜¯ `HistoryContext`ã€‚\r\n\r\nreact-router ä¸­çš„ä¸Šä¸‹æ–‡è®¾è®¡æˆ‘ä¸æ˜¯å¾ˆèƒ½ç†è§£ï¼Œ`RouterContext.Provider` ä½¿ç”¨äº†ä¸¤æ¬¡ï¼Œä¸Šä¸‹æ–‡ä¸­éƒ½æ˜¯ `history`ã€`location`ã€`match`\r\n\r\nä½†æ˜¯ç¬¬ä¸€ä¸ª `RouterContext` ä¸­æ•°æ®ä¸æ˜¯ç»™æˆ‘ä»¬ä½¿ç”¨çš„ï¼Œè€Œä¸”å…¶ä¸­çš„ `match` å’Œæˆ‘ä»¬çœŸæ­£ä½¿ç”¨çš„ `match` ä¸ä¸€æ ·ï¼Œ`Route` ç»„ä»¶åˆä½¿ç”¨äº†ä¸€æ¬¡è¯¥ä¸Šä¸‹æ–‡ï¼Œè¿™æ¬¡ä¼ é€’çš„ `value` æ‰æ˜¯æˆ‘ä»¬ç»„ä»¶ä¸­çœŸæ­£ä½¿ç”¨åˆ°çš„æ•°æ®ã€‚\r\n\r\n`HistoryContext` ä¸­çš„æ•°æ®åªæœ‰ä¸€ä¸ª `history` å¯¹è±¡ï¼Œç”¨äºç»™ `useHistory` hook æä¾› `history`ï¼Œæ˜æ˜ä½¿ç”¨ `RouterContext` å°±èƒ½å¤Ÿæ‹¿åˆ°éœ€è¦çš„ `history`ã€‚\r\n\r\n## matchPath\r\n\r\nè¯¥æ–¹æ³•ç”¨äºè¿›è¡Œè·¯å¾„åŒ¹é…ï¼Œç”¨äºå°†å½“å‰çš„è·¯å¾„å’Œé…ç½®çš„è·¯å¾„è§„åˆ™è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸè¿”å› `match` å¯¹è±¡ï¼Œå¦åˆ™è¿”å› `null`ã€‚\r\n\r\næ ¸å¿ƒæ˜¯åˆ©ç”¨ path-to-regexp åº“è¿›è¡ŒåŒ¹é…ï¼Œ`match` å¯¹è±¡çš„æ ¼å¼ï¼š\r\n\r\n```json\r\n{\r\n    isExact: true, // å½“å‰çš„è·¯å¾„å’Œè·¯ç”±é…ç½®çš„è·¯å¾„æ˜¯å¦æ˜¯ç²¾ç¡®åŒ¹é…çš„,è·Ÿ exat é…ç½®æ²¡å…³ç³»\r\n    params: {}, // è·¯å¾„è§„åˆ™ä¸­å¯¹åº”çš„å‚æ•°, /:id è¿™ç§\r\n    path: \"/\",  // è·¯å¾„è§„åˆ™\r\n    url: \"/\"  // çœŸå®è·¯å¾„ä¸­åŒ¹é…åˆ°è·¯å¾„è§„åˆ™çš„é‚£éƒ¨åˆ†\r\n}\r\n```\r\n\r\næ¯å½“éœ€è¦è¿›è¡Œè·¯å¾„åŒ¹é…çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œæˆ‘ä»¬ç»™ä¸€ä¸ªç»„ä»¶é…ç½®çš„è·¯å¾„è§„åˆ™å’Œé€‰é¡¹ä¾‹å¦‚ `exact`ï¼Œéƒ½ä¼šä¼ é€’è¿‡æ¥è¿›è¡Œåˆ¤æ–­ã€‚\r\n\r\n```javascript\r\nfunction matchPath(pathname, options = {}) {\r\n    if (typeof options === \"string\" || Array.isArray(options)) {\r\n        options = { path: options };\r\n    }\r\n\r\n    const { path, exact = false, strict = false, sensitive = false } = options;\r\n\r\n    // pathï¼ˆè·¯å¾„è§„åˆ™ï¼‰ å¯ä»¥æ˜¯ string,ä¹Ÿå¯ä»¥æ˜¯ []ï¼Œå¦‚æœ å‚æ•°ä¸æ˜¯ [], concat ä¹Ÿèƒ½æ‹¼æ¥\r\n    const paths = [].concat(path);\r\n\r\n    // åªè¦ path ä¸­æœ‰ä¸€ä¸ªèƒ½åŒ¹é…å°±å¯ä»¥\r\n    return paths.reduce((matched, path) => {\r\n        if (!path && path !== \"\") return null;\r\n        \r\n\t\t// ...å¤§æ®µå¤„ç†è¿‡ç¨‹\r\n\r\n        return { /* ...  */};\r\n    }, null);\r\n}\r\n```\r\n\r\n## Router\r\n\r\nå› ä¸ºå­˜åœ¨ä¸‰ç§ä¸åŒçš„è·¯ç”±ç»„ä»¶ï¼Œä½†æ˜¯æ ¸å¿ƒé€»è¾‘æ˜¯ç›¸åŒçš„ï¼Œ`Router` ç»„ä»¶å°±æ˜¯æ‰€æœ‰è·¯ç”±ç»„ä»¶éƒ½ä½¿ç”¨çš„æ ¸å¿ƒç»„ä»¶ï¼Œåªéœ€è¦ä¼ é€’ä¸åŒç±»å‹çš„ `history` å³å¯ã€‚\r\n\r\n`Router` ç»„ä»¶åšçš„äº‹å¾ˆç®€å•ï¼Œå°±æ˜¯æä¾›ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¸»è¦æ˜¯ç»™å†…éƒ¨ç»„ä»¶æä¾›çš„ï¼Œé—´æ¥çš„ç»™æˆ‘ä»¬çš„ç»„ä»¶æä¾›ã€‚\r\n\r\nå…¶ä¸­è¿›è¡Œäº†ä¸€äº›å¿…è¦çš„å¤„ç†ï¼Œå­˜åœ¨å­ç»„ä»¶åœ¨ `Router` ç»„ä»¶æ²¡æœ‰ mount å®Œæ¯•å°±æ”¹å˜ URL çš„æƒ…å†µã€‚\r\n\r\n![](http://oss.xiefeng.tech/img/20210411155549.png)\r\n\r\n## Route\r\n\r\n`Route` ç»„ä»¶çš„ä½œç”¨ï¼š\r\n\r\n1. æ ¹æ®è·¯å¾„è§„åˆ™é…ç½®æ¥é…æ¸²æŸ“æˆ‘ä»¬çš„ç»„ä»¶\r\n2. ä¸ºæˆ‘ä»¬çš„ç»„ä»¶æä¾›ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä»¥åŠå°†ä¸Šä¸‹æ–‡ä¸­çš„æ•°æ®ä½œä¸º `props` ä¼ å…¥\r\n\r\n`Route` ç»„ä»¶å¯ä»¥ä¼ å…¥ `component`ã€`render`ã€`children`ï¼Œä½†æ˜¯æ¸²æŸ“çš„ä¼˜å…ˆçº§æ˜¯ä¸åŒçš„ï¼Œè¿™é‡Œæ‰æ˜¯ `Route` ç»„ä»¶çš„æ ¸å¿ƒã€‚\r\n\r\nä¼˜å…ˆçº§ï¼š`children`ï¼ˆå‡½æ•°ï¼‰> `children`ï¼ˆnodeï¼‰> `component`ï¼ˆnodeï¼‰ > `render`ï¼ˆå‡½æ•°ï¼‰\r\n\r\nå½“ `children` ä¸ºå‡½æ•°æ—¶ï¼Œå³ä½¿è¯¥è·¯ç”±æ²¡æœ‰åŒ¹é…ä¹Ÿä¼šæ¸²æŸ“ã€‚\r\n\r\nå½“æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Route ç»„ä»¶æ—¶ï¼Œæ¯ä¸ª Route ç»„ä»¶æ˜¯ä¸€å®šä¼šè¢«æ¸²æŸ“çš„ï¼Œåªä¸è¿‡ä¼šæ ¹æ®æˆ‘ä»¬é€’çš„è·¯å¾„è§„åˆ™è¿›è¡Œ mathPath è¿›è¡Œåˆ¤æ–­æ˜¯å¦æŠŠæˆ‘ä»¬çš„ç»„ä»¶æ¸²æŸ“å‡ºæ¥ã€‚\r\n\r\nè€Œå½“æˆ‘ä»¬ä½¿ç”¨äº† `Switch` ç»„ä»¶æ—¶ï¼Œåªæœ‰åŒ¹é…åˆ°çš„ç¬¬ä¸€ä¸ªæ‰ä¼šè¢«æ¸²æŸ“ï¼Œä¸ºäº†æé«˜ä¼˜å…ˆçº§ `Switch` ä¼šä¼ é€’ `computedMatch` å±æ€§ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ª `match` å¯¹è±¡ï¼Œåªä¸è¿‡åç§°ä¸åŒè€Œå·²ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ é€’ä¸è¿‡æ²¡å¿…è¦ã€‚\r\n\r\n![](http://oss.xiefeng.tech/img/20210411155338.png)\r\n\r\n## Switch\r\n\r\nSwitch ç»„ä»¶ç”¨äºæ¸²æŸ“ç¬¬ä¸€ä¸ªåŒ¹é…çš„ Route ç»„ä»¶ / Redirect ç»„ä»¶ã€‚\r\n\r\nå…¶å®æ²¡å¿…è¦ä¸€å®šæ˜¯ Route / Redirectï¼Œåªè¦ä¸€ä¸ªç»„ä»¶ä¼ é€’äº† path / from å±æ€§ï¼ŒSwitch éƒ½ä¼šæ¸²æŸ“ã€‚\r\n\r\n![](http://oss.xiefeng.tech/img/20210411154250.png)\r\n\r\n## Lifecycle\r\n\r\næ­£å¦‚åå­—é‚£æ ·ï¼Œè¿™ä¸ªç»„ä»¶ä¸æ˜¯ç”¨æ¥æ¸²æŸ“çš„ï¼Œæ˜¯ç”¨æ¥åœ¨ç”Ÿå‘½å‘¨æœŸå¤„ç†å„ç§äº‹æƒ…çš„ï¼Œæ˜¯ä¸€ä¸ªå·¥å…·ç»„ä»¶ã€‚\r\n\r\n```jsx\r\nclass Lifecycle extends React.Component {\r\n    componentDidMount() {\r\n        if (this.props.onMount) this.props.onMount.call(this, this);\r\n    }\r\n\r\n    componentDidUpdate(prevProps) {\r\n        if (this.props.onUpdate) this.props.onUpdate.call(this, this, prevProps);\r\n    }\r\n\r\n    componentWillUnmount() {\r\n        if (this.props.onUnmount) this.props.onUnmount.call(this, this);\r\n    }\r\n\r\n    render() {\r\n        return null;\r\n    }\r\n}\r\n```\r\n\r\n## Redirect\r\n\r\n`Redirect` ç»„ä»¶ç”¨äºå®ç°è·³è½¬ï¼Œä½†æ˜¯ä¸èƒ½åœ¨ render çš„æ—¶å€™å°±è·³è½¬ï¼Œè¿™å°±ç›¸å½“äºåœ¨ render æ—¶è§¦å‘ rerenderï¼Œä¸åˆç†ã€‚æ‰€ä»¥éœ€è¦åœ¨ cdm ä¸­è¿›è¡Œï¼Œåˆ©ç”¨å†™å¥½çš„ `Lifecycle` ç»„ä»¶åªéœ€è¦ä¼ é€’å›è°ƒå°±å¯ä»¥ã€‚\r\n\r\nè€Œä¸”å•ç‹¬ä½¿ç”¨ `Redirect` æ˜¯æ²¡åŠæ³•ä½¿ç”¨ `from` å±æ€§è¿›è¡ŒåŒ¹é…çš„ï¼Œåªæœ‰ä½¿ç”¨ `Switch` æ—¶æ‰å¯ä»¥ä½¿ç”¨ï¼Œå› ä¸º `from` çš„åŒ¹é…åœ¨ `Switch` ç»„ä»¶å®Œæˆã€‚\r\n\r\n![](http://oss.xiefeng.tech/img/20210411155107.png)","meta":{"size":20110,"birthTime":1663496641422.3535,"updateTime":1663496641422.5254}}},"__N_SSG":true}