name: Building、Transfering and Updating Client Service

on:
  push:
    branches:
      - main
    paths:
      - 'apps/client/**'
  workflow_dispatch: 

env:
  TZ: Asia/Shanghai
    
jobs:
  build: 
    runs-on: ubuntu-latest
    steps:    
    - name: Checkout Repository
      uses: actions/checkout@v3.5.2
      
    - name: Create .env.production
      run: |
        echo "SERVER_HOST=${{ secrets.SERVER_HOST }}" > apps/client/.env.production
        echo "REVALIDATE_TOKEN=${{ secrets.REVALIDATE_TOKEN }}" >> apps/client/.env.production
        
    - name: Parse Current Building Time
      id: build_time
      run: |
        echo "time=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_OUTPUT
        
    - name: Build Docker Image
      run: docker build -f apps/client/Dockerfile -t 0x1461a0.me/client:${{ steps.build_time.outputs.time }} .
      
    - name: Save Docker Image
      run: |
        docker save 0x1461a0.me/client:${{ steps.build_time.outputs.time }} > ${{ steps.build_time.outputs.time }}.tar
    
    - name: Transfer Docker Image to Aliyun
      uses: appleboy/scp-action@master
      with:
        host: xiefeng.tech
        username: github_actions
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ${{ steps.build_time.outputs.time }}.tar
        target: /home/github_actions/xiefeng.tech/client

    - name: Update Service on Aliyun
      uses: appleboy/ssh-action@master
      with:
        host: xiefeng.tech
        username: github_actions
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # if 0x1461a0.me_client exist stop and remove it
          if (docker ps -a | grep 0x1461a0.me_client); then
            docker stop 0x1461a0.me_client
            docker rm 0x1461a0.me_client
          fi
          # load image and run it
          cd /home/github_actions/xiefeng.tech/client
          imageId=$(docker load -i ${{ steps.build_time.outputs.time }}.tar)
          docker run -id -p 3000:3000 --name=0x1461a0.me_client $imageId

        
    
