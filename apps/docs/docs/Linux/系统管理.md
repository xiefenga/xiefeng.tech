## 网络管理

### 工具包

`net-tools` 和 `iproute2` 是 Linux 下管理网络协议栈和网络设备的软件包

- `net-tools`
  - 起源于 BSD，Linux 社区自 2001 年起已经对其停止维护
  - 通过 `procfs(/proc)` 和 `ioctl` 系统调用去访问和改变内核网络配置
  - 工具的名字比较杂乱，例如 `ifconfig`、`route`、`netstat` 都是包下的命令
- `iproute2` 
  - 旨在取代 `net-tools`，并提供了一些新功能
  - 通过 `netlink` 套接字接口与内核通讯
  - 工具的名字相对整齐直观，基本是 `ip` 命令加子命令

### 网卡操作

`ifconfig` 可以查看、修改网卡 IP 地址，以及可以禁用启用网卡

```shell
$ ifconfig # 查看 IP 地址

$ ifconfig eth0 # 查看具体网卡的 IP 地址

$ ifconfig <网卡> <IP> [netmask ⼦网掩码] # 修改 IP 地址

$ ifconfig eth0 down # 启用网卡
$ ifconfig eth0 up   # 禁用网卡

$ ifup <网卡>    # 启用网卡
$ ifdown <网卡>  # 禁用网卡
```

CentOS 7 中 `systemd` 和 `udev` 引入了一种新的网络设备命名方式：一致网络设备命名

在 CentOS 7 中第⼀个⽹络接口的名称可能为：

- `eno1` 板载⽹卡
- `ens33` PCI-E ⽹卡
- `enp0s3` ⽆法获取物理信息的 PCI-E ⽹卡

我们一般习惯了 `eth0` 这样的网络设备命名，需要通过更改**grub配置**重命名网卡名称

⽹卡命名规则受 `biosdevname` 和 `net.ifnames` 两个参数影响

1. 编辑 `/etc/default/grub` 文件，增加 `biosdevname=0 net.ifnames=0` 
2. `grub2-mkconfig -o /boot/grub2/grub.cfg` 更新 grub
3. `reboot` 重启系统

[CentOS 7中的网卡一致性命名规则、网卡重命名方法](https://www.cnblogs.com/zyd112/p/8143464.html) 

`mii-tool` 可以查看网卡的物理连接情况

```shell
$ mii-tool eth0
```

### 网关操作

使用 `route` 命令可以查看和操作 IP 路由表

```shell
$ route # 查看路由表

$ route -n # -n 参数不解析主机名
```

![](https://oss.xiefeng.tech/images/20230124215303.png)

使用 `route add` 添加网关，`route del` 删除一条路由

```shell
$ route add default gw <⽹关ip>
$ route add -host <指定ip> gw <网关ip>
$ route add -net <指定⽹段> netmask <⼦网掩码> gw <⽹关ip>
```

添加默认网关时需要先删除当前的默认网关

### 网络追踪

`traceroute` 用于追踪数据包在网络上的传输时的全部路径，默认发送的数据包大小是 40 字节

```shell
$ traceroute baidu.com
traceroute to baidu.com (39.156.66.10), 30 hops max, 60 byte packets
 1  192.168.10.1 (192.168.10.1)  15.570 ms  15.526 ms  15.479 ms
 2  192.168.1.1 (192.168.1.1)  7.419 ms  7.758 ms  7.774 ms
 ...
11  * * *
12  * * *
13  * 10.166.96.102 (10.166.96.102)  27.342 ms *
```

- 记录按序列号从 `1` 开始，每个纪录就是一跳 ，每跳表示一个网关
- 有时会看到有一些行是以星号表示的，可能是防火墙封掉了 ICMP 的返回信息，所以我们得不到什么相关的数据包返回数据
- 有时在某一网关处延时比较长，有可能是某台网关比较阻塞，也可能是物理设备本身的原因

在局域网中的不同网段之间，我们可以通过 `traceroute` 来排查是主机的问题还是网关的问题

- `mtr` 
  - 全称 my traceroute，是结合了 `traceroute` 命令和 `ping` 命令功能的网络诊断工具
  - 会收集更多的信息，比如连接状态、可用性等等，在排查网络问题中，非常有用

- `nslookup`: 查询域名对应的 IP 
- `telnet`: [可以用来确定远程服务的状态，比如确定某个端口是否能访问](https://www.cnblogs.com/peida/archive/2013/03/13/2956992.html) 
- `tcpdump`: 抓包 TCP
- `netstat`: 显示网络状态，查看整个系统的网络情况

### 主机名

主机名用于在局域网中标识一台机器，以便于以容易记忆的方法来相互访问

登陆 linux 后会显示 `[root@xxx ~]`，`@` 后面的就是主机名，通过主机名可以判断登陆的系统

主机名的配置文件大多是 `/etc/hosts`，主机名查询静态表，把主机名映射到 IP 地址

`hostname` 用于查询和设置系统的主机名

- 环境变量 `HOSTNAME` 也保存了当前的主机名。
- 使用 `hostname` 命令设置主机名，系统并不会永久保存新的主机名，重启之后还是原来的主机名
  - 要永久修改主机名，需要修改 `/etc/hosts` 和 `/etc/sysconfig/network` 并进行重启
  - 也可以使用 `hostnamectl` 命令进行永久修改

```shell
$ hostname # 查询主机名

$ hostname 0x1461A0 # 临时设置主机名

$ hostname -I # 查询主机的所有 IP 地址

$ hostnamectl set-hostname 0x1461A0 # 永久修改主机名
```

使用 `hostnamectl` 命令修改之后，注意修改 `/etc/hosts` 文件防止有些程序出错

### 配置文件

不同 Linux 发行版的网络配置文件有所不用，Red Hat Linux / CentOS 系列网络配置文件路径：

- `/ect/hosts` 配置主机名（域名）和 IP 地址的对应
- `/etc/sysconfig/network-scripts/ifcfg-ethx` 
  - `ethX` 是网卡接口的名称，也可能是其他名称，例如 `emX` 等
  - 每一个网卡对应一个配置文件
- `/etc/sysconfig/network`  指定系统的网络配置信息
- `/etc/resolv.conf`  DNS 客户端配置文件，用于设置DNS服务器的IP地址及DNS域名

#### ifcfg-文件

修改 `BOOTPROTO` 设置是手动设定 IP 还是 DHCP 

手动配置 IP 对应的配置文件

```shell
BOOTPROTO=static    # 静态地址，还有其他选项[none|dootp|dhcp]
IPADDR=192.168.0.2    # IP地址
NETMASK=255.255.255.0    
GATEWAY＝192.168.0.1
```

#### hosts文件

最左边一列是主机 IP 信息，中间一列是主机名.域名，任何后面的列都是该主机名别名(主机名)

```shell
127.0.0.1       localhost.localdomain localhost
::1     localhost6.localdomain6 localhost6
```

修改网络的配置文件后，需要重启网络服务才会生效

```shell
$ service network restart
```

### 网络服务

