## 用户切换

使用 `su` 命令切换用户，如果 username 为空，则相当于 `su root`

```shell
su username
```

通过 `su -` 可以使用 login shell 的方式登录，直接会自动进入家目录

```shell
su - username
```

`su` 和 `su -` 最大的本质区别就是：

- 前者只是切换了身份，Shell环境没有改变；而后者连用户和Shell环境一起切换了
- 切换了Shell环境不会出现PATH环境变量错误，用 `echo $PATH` 看一下 `su` 和 `su -` 后的环境变量有何不同
- `su` 以后工作目录不会发生变化，`su -` 切换以后，工作目录变成用户的家目录

## 配置文件

- `/etc/passwd`               存储用户配置文件
- `/etc/group`                 存储用户组配置文件
- `/etc/shadow`               存储用户密码的配置文件

### 用户配置

![](http://oss.xiefeng.tech/img/20210413141542.png)

该文件每一行都是一个用户的信息：

```shell
user:x:uid:gid:注释:home:shell
```

- 用户名
- 密码：`x` 表示需要验证密码，空表示可直接登录，也可以理解为 `x` 表示密码(占位)，为空系统认为该用户无密码(即可登录)
- 用户ID：Linux 通过 uid 来识别每个用户，若将某个用户的 uid 改为 0，则该用户将拥有 root 权限
- 用户组ID：该用户所属的主组的 id
- 注释
- 家目录
- 解释器：用户进入系统使用用的命令解释器，`nologin` 表示该用户无法登录终端

### 用户组配置

![](http://oss.xiefeng.tech/img/20210413150554.png)

该文件每一行都是一个用户组的信息：

```shell
用户组名:密码:用户组ID:组内用户名
```

- 用户组名
- 密码：代表用户组的密码，主要是用来指定组管理员，功能目前很少使用，可以使用 sudo 代替组管理员
- 用户组ID
- 组内用户名：表示附加组是该组的用户名称

### 用户密码

密码显示的加密之后的密码，`!` 表示还没有设置密码。并且即使设置相同密码的不同用户在该文件中密码显示的内容也不相同

![](http://oss.xiefeng.tech/img/20210413150844.png)

## 用户管理

用户的管理实际上就是对相应配置文件的更新。

### 添加用户

```shell
useradd [-gGu] username
```

- `-g`：指定用户的主组，选项的值可是用户组 id，也可以是组名，系统默认会创建同名的用户组，然后默认主组为就是它
- `-G`：指定用户的附加组，选项的组可以是用户组 id，也可以是组名
- `-u`：指定用户的 id，系统默认会从 500之 后按顺序分配
- `-c`：添加关于用户的注释

![](http://oss.xiefeng.tech/img/20210413141203.png)

### 修改用户

```shell
usermod [-gGul] username
```

- `-g`：用户主组，选项的值可以是用户组的id，也可以是组名
- `-G`：用户附加组，选项的值可以是用户组的id，也可以是组名
- `-u`：用户 id
- `-l`：用户名

```shell
# 修改zhangsan用户主组为500，附加组改为501
usermod -g 500 -G 501 zhangsan

# 修改zhangsan用户用户名，改为wangerma
usermod -l wangerma zhangsan
```

修改帐号和密码的有效期限

```shell
chage [选项] 用户名
```

- `-m`：密码可更改的最小天数。为零时代表任何时候都可以更改密码
- `-M`：密码保持有效的最大天数
- `-w`：用户密码到期前，提前收到警告信息的天数
- `-E`：帐号到期的日期，过了这天，此帐号将不可用(无法登录系统)
- `-i`：停滞时期，如果一个密码已过期这些天，那么此帐号将不可用(无法登录系统)
- `-l`：例出当前的设置

`/etc/login.defs` 和 `/etc/default/useradd` 是新建用户使用的默认配置，而目前系统已经存在的用户需要使用 chage 来修改

### 设置密码

Linux 不允许没有密码的用户登录到系统，刚创建没有设置密码的用户都处于锁定状态，需要设置密码之后才能登录计算机。

```shell
passwd username
```

![](http://oss.xiefeng.tech/img/20210413142450.png)

### 删除用户

```shell
userdel [-r] username
```

- `-r`：表示删除用户的同时，删除其家目录

已经登录的用户删除的时候提示删除失败，没有登录的用户可以正常删除，解决办法是 kill 对应用户的全部进程。

## 用户组管理

每个用户都有一个用户组，系统可以对一个用户组中的所有用户进行集中管理。

用户组的管理实际上就是对 `/etc/group` 文件的更新。

### 用户组添加

```shell
group [-g] groupname
```

- `-g`：用户组的 id，系统默认从 500 之后递增

![](http://oss.xiefeng.tech/img/20210413150022.png)

### 用户组编辑

```shell
groupmod [-g-n] groupname
```

- `-g`：用户组的 id
- `-n`：用户组的名称

### 用户组删除

```shell
groupdel groupname
```

删除一个组时，但是**这个组是某个用户的主组时**，则不允许删除；确实需要删除，则需要先从组内移出所有用户

## 文件权限

通过 `ls -l` 可以查看文件的属性，用于显示文件的文件名和相关属性。

![](https://oss.xiefeng.tech/images/20220110141156.png)

权限总共九个字符，对应三种身份：属主、属组、其他人，三种权限分别为：读、写、执行

**文件类型**

- `-`：普通⽂件
- `d`：⽬录⽂件
- `b`：块特殊⽂件
- `c`：字符特殊⽂件
- `l`：符号链接
- `f`：命名管道
- `s`：套接字⽂件

创建新⽂文件有默认权限，根据 umask 值计算，属主和属组根据当前进程的⽤用户来设定

默认权限：`666 - umask(022) = 644`

### 权限区别

Linux 系统将用户对一个文件的权限分为读、写、执行

- 对于普通文件
  - 读权限影响是否可以查看文件内容
  - 写权限影响是否可以编辑文件内容
  - 执行权限影响文件是否可以执行
- 对于目录
  - 读权限影响是否能够列出目录结构
  - 写权限影响是否可以在文件夹下“创建/删除/复制/移动”文档
  - 执行权限影响能否进⼊⽬录

### 权限表示

- 字符权限表示

  - `r`：读

  - `w`：写

  - `x`：执⾏
- 数字权限的表示

  - `r = 4` 
  - `w = 2` 
  - `x = 1` 

![](http://oss.xiefeng.tech/img/20210413155838.jpg)

### 权限设置

通过 `chmod` 命令可以修改文件的权限：

```shell
chmod [-R] 权限 文件
```

- `-R`：递归设置权限（对于文件夹），文件夹和文件夹下的文档权限都会被修改
- 权限模式：就是该文档需要设置的权限信息

#### 符号模式

- `u`：表示所有者身份
- `g`：表示给所有者同组用户设置
- `o`：表示给其他用户设置权限
- `a`：表示给所有人设置权限

如果在设置权限的时候不指定给谁设置，则默认给所有用户设置

- `+`：表示给具体的用户新增权限
- `-`：表示减少用户的权限
- `=`：表示将权限设置成具体的值

```shell
chmod  u+x,g+rx,o+r anaconda-ks.cfg
```

![](https://oss.xiefeng.tech/images/20220110175112.png)

如果有两部分权限一样则可以合在一起写

```shell
chmod ug=rwx
```

#### 数字形式

设置的时候，只需要按照拥有者、同组用户、其他用户的顺序给定三个数字即可。

```shell
chmod 754 anaconda-ks.cfg
```

### 所属设置

- `chown`：更改文件的属主、属组
- `chgrp`：可以单独更改文件的属组

```shell
chown owner[:group] file
chgrp group file
```

当属主和属组的权限冲突时（属主属于属组），以属主的权限为主

## 特殊权限

- `SUID`：⽤于⼆进制可执行文件，执行命令时取得文件属主权限，如 `/usr/bin/passwd`
- `SGID`：⽤于目录，在该目录下创建新的文件和目录，权限自动更改为该目录的属组
- `SBIT`：⽤于目录，该目录下新建的文件和目录，仅 root 和自己可以删除，如 `/tmp`

# sudo

有些指令在普通用户身份上都是操作不了，但是有些特殊的情况下又需要有执行权限。

`sudo` 可以让 root 事先定义某些特殊命令谁可以执行。

默认 sudo 中是没有除 root 之外用户的规则，要想使用则先**配置** sudo

配置文件路径：`/etc/sudoers`

配置 sudo 文件需要使用 `visudo` 指令，打开之后其使用方法和 vim 一致。

普通用户通过 `sudo -l` 查看自己具有的特殊权限

`sudo` 不是任何 Linux 分支都有的命令，常见 centos 与 ubuntu 都存在 `sudo` 命令
